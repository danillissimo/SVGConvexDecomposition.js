<html>

<head>
    <script type="text/javascript" src="./script/vector.js"></script>
    <script type="text/javascript" src="./script/sleep.js"></script>
    <script type="text/javascript" src='./script/polarCoords.js'></script>
    <script type="text/javascript" src='./script/bezier.js'></script>
    <script type="text/javascript" src="./script/collisionSVGModelProcessor.js"></script>
    <script type="text/javascript" src="./script/visualizingCollisionModelProcessor.js"></script>
    <script type="text/javascript" src="./script/polyVertexList.js"></script>
</head>

<body onload="init()">
    <div style="position: fixed; top: 0px; left: 0px; width: 100%;">
        <div style="background-color: antiquewhite; outline: 2px solid blueviolet; padding: 4px; margin: 4px; width: fit-content; margin-left: auto; margin-right: auto;">
            <div style="width: fit-content; margin-left: auto; margin-right: auto;">
                Millis interval:<input id='speed' type="number" value="75" min="0" step="25" onchange="setSpeed()"
                    onkeypress="setSpeed()" />
                <button onkeypress="processor.step()" onclick="processor.step()">Step</button>
                <button onkeypress="stop()" onclick="stop()">Stop</button>
            </div>
            <div style="font-size: 12px; text-align: center;">Changing millis or pressing any key when it's selected resumes algorithm with given speed<br>0 interval prevents auto execution<br>Key or mouse press on a button performs a step</div>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <svg id='canvas' width='1500' height='1350'>
        <!--треугольник с вогнутостью-->
        <path id='path0' fill='transparent' stroke='blue' stroke-width='1'
            d="m 17.841101,172.15385l44.601191,55.94047l41.577378,-63.49999l-43.845236,28.72619 z" />
        <!--звезда-->
        <path id='path1' fill='transparent' stroke='blue' stroke-width='1'
            d="m 353.63136,-26.427968l-18.87712,70.474573l-44.04661,-45.305081l22.65254,51.597461l-57.88983,7.55084l46.56356,15.1017l-42.78813,39.012715l49.0805,-21.394075l-12.58474,54.114415l35.23728,-44.04661l28.94492,49.08051l-3.77543,-50.338995l55.37289,21.394075l-45.30509,-45.305085l64.1822,-25.16949l-60.40678,1.25847l30.2034,-64.182203l-39.01272,52.855933 z" />
        <!--зигзаг-->
        <path id='path2' fill='transparent' stroke='blue' stroke-width='1'
            d="m 116.19915,221.49152l30.20339,-65.86017l20.97458,44.8856l15.52118,-49.08051l16.36017,48.24152l21.39407,-48.24152l38.17373,79.70339l-36.49577,-49.08051l-21.81355,42.78813l-18.03814,-37.33474l-18.87712,33.13983l-15.94068,-28.94492 z" />
        <!--буква G-->
        <path id='path3' fill='transparent' stroke='blue' stroke-width='1'
            d="m 109.48729,272.25l-24.750002,-20.97458l-48.661018,6.71187l-29.3644058,45.72458l26.0084738,49.0805l63.34322,2.09746l30.622882,-40.2712l-21.81356,-20.55508l-44.466101,0.4195l-23.491525,24.74999l46.144068,17.19916l2.936441,-21.39407l-16.360172,-10.48729l33.559319,2.51695l-11.745759,33.13983l-50.758473,-0.41949l-18.038136,-36.91525l26.008473,-32.30084 z" />
        <!--клякса-->
        <path id='path4' fill='transparent' stroke='blue' stroke-width='1'
            d="m 281.4788,315.03813l-49.91948,37.75424l-57.88983,-2.09746l21.81356,-33.55932l-48.24153,4.19491l40.69068,-31.46187l8.80932,-45.72457l24.33051,41.11019l3.77542,-34.81781l46.14406,21.81356l-20.97456,26.42796l-33.13983,22.65254 z" />
        <!--крест-->
        <path id='path5' fill='transparent' stroke='blue' stroke-width='1'
            d="M 19.719094,9.4189005L37.516614,37.44999L6.3709642,20.987287L7.7057742,70.820338L37.071674,52.577881L15.714654,91.73242L94.913604,89.50773L54.424254,53.02282L96.693354,73.934902L92.688914,11.198651L57.983764,36.115178L75.781274,7.1942125 Z" />
        <!--прямоугольник с вогнутостью-->
        <path id='path6' fill='transparent' stroke='blue' stroke-width='1'
            d="m 15.101695,107.38983l-0.838984,50.33898l79.70339,-1.25847l-4.194916,-52.43644l-41.52966,36.07627 z" />
        <!--клевер-->
        <path id='path7' fill='transparent' stroke='blue' stroke-width='1'
            d="m 500.44047,171.51191l-30.99404,-54.42857l41.57738,-47.625l88.44642,0.75595l27.21429,38.55357l-31.75,65.0119l50.64881,-52.91666l66.52377,6.04762l1.5119,161.01785l-79.37496,-9.82738l-34.77381,-46.11309l43.84524,86.93451l-98.27381,33.26191l-94.49404,-44.60118l89.95833,-66.52381l-101.29762,48.38095l-38.55357,-61.9881l18.14286,-56.69642 z" />
        <!--сложный тест не запарсится-->
        <path id='path8' fill='transparent' stroke='blue' stroke-width='1'
            d="m 360.58929,424 202.59523,2.26785 19.65476,16.63097 27.21429,-19.65476 20.41071,20.4107 34.01786,-23.43452 76.35116,84.66667 39.3095,-85.42264 h 29.4822 l -2.2679,180.67264 -40.0654,-0.75597 -23.4346,-26.45833 -27.2143,27.2143 -25.7023,-30.99406 -30.23812,29.48215 -82.39881,-74.83928 -65.0119,74.08334 -148.16667,-4.53573 z" />
        <!--шляпа ~~~ треугольник с навершием-->
        <path id='path9' fill='transparent' stroke='blue' stroke-width='1'
            d="M 851.9583,396.02977L798.2857,352.18453L731.006,390.7381L807.3572,174.53572L887.4881,285.66071L811.8929,221.40477 Z" />
        <!--простой тест-->
        <path id='path10' fill='transparent' stroke='blue' stroke-width='1'
            d="m 755.9524,166.22024l63.5,-37.79762l14.3631,37.04167l12.8512,-17.3869l9.0714,17.3869l49.1369,-2.26786l-1.5119,-138.33929l-56.6964,38.55358l-11.3393,-40.82143l-14.3631,30.2381l-26.4584,-44.6012l-49.8928,15.875 z" />
        <!--средний тест-->
        <path id='path11' fill='transparent' stroke='blue' stroke-width='1'
            d="m 942.6726,502.61906 v 107.34521 h -29.4821 l -17.3869,-24.19045 l -15.1191,22.67857 l -12.0952,-23.43454 l -11.3393,22.67857 l -32.506,-3.77976 l 3.0238,-111.88093 l 43.0893,-8.31549 l 11.3393,49.13691 l 15.875,-53.67263 l 24.1905,1.5119 l 6.0476,18.89882 z" />
        <!--остров-->
        <path id='path12' fill='transparent' stroke='blue' stroke-width='1'
            d="m 90.845633,1300.4034 101.294757,0.016 0.0996,10.2724 26.2475,1.1396 -0.0559,-11.7278 158.25441,8.0857 9.04263,-5.9269 4.94441,8.6106 211.74291,16.2315 4.19381,-4.5604 c 0,0 35.78694,11.5114 53.26313,5.3637 1.54236,-0.5422 2.74294,-3.1563 4.29121,-3.6365 11.36493,-3.5253 34.39558,6.255 34.39558,6.255 l 6.45124,9.4434 84.04172,-0.916 14.56226,-4.6242 5.56706,7.8736 c 0,0 65.8293,5.3254 70.5219,-9.937 2.49577,-8.1171 2.57088,-31.7889 2.57088,-31.7889 l 57.78449,-11.5819 1.87419,27.8531 52.58467,-10.5077 1.54309,12.0492 c 0,0 45.09882,-3.4929 67.57572,-7.1501 3.3652,-0.5475 4.9189,-7.1032 8.4693,-7.7132 11.8744,-0.2439 34.3408,-16.1949 34.3408,-16.1949 l 1.4225,7.8566 6.1663,-3.4026 -1.2829,-7.1299 c 0,0 9.9782,-13.1493 15.7253,-16.2969 7.9798,-4.3698 26.3629,-7.0885 26.3629,-7.0885 13.3764,0.5048 20.1591,-4.487 36.1152,-5.5904 2.0488,-0.1411 1.8326,4.9693 3.93,4.8157 5.1568,-0.3774 8.3367,-6.8015 13.7525,-5.6329 5.2466,1.1323 33.0728,19.618 33.0728,19.618 l 4.5301,-24.4275 c 0,0 158.1666,12.2467 163.7801,7.5552 9.3107,-7.7822 17.0441,-24.7957 20.3076,-42.9319 2.7022,-15.0173 0.7917,-32.3912 -1.8856,-47.4244 -3.6615,-20.561 -11.7494,-37.4361 -18.7174,-54.7198 -13.5638,-33.6447 -29.3845,-63.8839 -44.707,-94.75 -11.874,-23.92018 -23.3695,-48.73411 -36.576,-70.04698 -10.5544,-17.0324 -21.5749,-33.58915 -33.8648,-45.84363 -2.0079,-2.00228 -4.5774,-1.86668 -6.4032,-4.41149 -4.3485,-6.06115 -5.7185,-17.63586 -9.7751,-24.37399 -6.65,-11.04548 -15.6493,-15.83494 -23.0711,-24.98169 -11.715,-14.43751 -31.2309,-46.87299 -33.7564,-47.04907 -2.6667,-0.1857 -0.5579,8.08582 -3.9082,11.23627 -6.1276,5.76245 -15.0096,1.89718 -20.2793,-6.33219 -3.2954,-5.14619 -1.4219,-16.89252 -4.3896,-22.69993 -8.2433,-16.13069 -22.0187,-17.00016 -33.0374,-25.45678 -21.6618,-16.62504 -42.404,-38.44099 -65.0227,-49.70435 -3.6318,-1.80857 -7.6181,-0.50284 -11.1739,-2.7824 -5.7322,-3.67526 -10.8234,-10.42657 -15.7141,-17.1392 -1.8658,-2.56108 -2.974,-7.22183 -5.1384,-8.74263 -4.1059,-2.88494 -8.784,1.27089 -13.1484,0.49777 -10.3763,-1.83848 -20.2318,-10.00535 -30.592,-12.13772 -9.2243,-1.89871 -18.5632,0.0707 -27.83718,-0.53015 -13.06834,-0.8509 -144.30242,11.55898 -163.63399,0.87417 -4.61499,-2.55085 -7.05203,-14.22001 -11.80702,-15.59072 -3.07915,-0.88729 -5.79648,4.95145 -8.90534,5.3252 -4.57545,0.55045 -8.94703,-4.50715 -13.53134,-4.63515 -9.22793,-0.25786 -18.15031,7.18545 -27.37336,7.80586 -13.4684,0.90555 -26.82854,-5.72808 -40.30479,-5.99901 -22.77094,-0.45707 -45.563,11.99783 -68.20304,7.39578 -2.62612,-0.53421 -4.99843,-4.43981 -7.63016,-4.01686 -4.30074,0.69106 -7.40412,9.5564 -11.69436,10.4476 -6.29671,1.30792 -12.19689,-7.94137 -18.53195,-7.91892 -4.41832,0.0172 -8.50054,5.211 -12.91361,5.61469 -4.35791,0.39874 -8.63083,-3.8795 -12.97844,-3.19086 -3.17373,0.50286 -9.13269,5.27709 -9.13269,5.27709 l -3.87928,-19.47644 -25.56046,11.45249 2.47751,21.47518 -8.05669,1.95667 0.74906,15.06591 -93.90784,11.37662 0.62819,14.10997 86.82864,-11.54585 c 0,0 1.48805,40.20342 0.92762,58.86861 -0.56043,18.66514 -2.85091,48.72792 -2.85091,48.72792 l -69.3059,10.4155 -10.02005,-60.39987 -6.07405,3.46573 5.4413,33.38065 c -27.20518,26.13223 -59.23972,24.91568 -85.16039,12.77064 -9.81196,-4.17544 -22.79341,15.91531 -31.71135,-9.86998 -1.81235,-5.24041 4.33391,-25.49418 -9.11534,-39.69555 -2.95857,-3.12416 0.0323,18.2823 -2.74676,18.44819 -5.82006,0.34815 -18.2842,-23.93971 -19.23142,-37.74546 -0.53429,-7.78779 9.15625,-11.37102 3.25651,-29.76219 -3.3636,-10.48512 -10.11362,-4.53861 -14.56184,-7.38236 -4.44819,-2.84379 -1.25733,-8.81438 -2.81779,-9.6311 -3.23201,-1.69169 -4.81707,9.81292 -9.20184,10.51249 0,0 -56.31168,3.06799 -80.37631,10.67281 -2.46951,0.7801 -4.37498,5.0723 -6.84908,5.7993 -4.35853,1.28058 -8.86652,-0.82358 -13.14981,-2.80728 -1.82664,-0.84584 -3.48019,-4.9716 -5.2616,-3.83557 -3.29784,2.10311 -2.07958,14.96672 -5.42691,16.77253 -2.16533,1.16809 -3.87676,-4.51494 -6.03986,-5.69749 -3.81512,-2.08576 -7.90347,-2.95729 -11.85942,-2.25848 -4.29992,0.75982 -8.1176,7.61157 -12.42109,6.92637 -3.06313,-0.48767 -5.23164,-8.492 -8.27333,-7.65519 -3.18546,0.87617 -4.04456,10.31596 -7.07688,12.34743 -2.13136,1.42794 -4.61745,-2.08981 -6.77487,-0.8074 -2.06373,1.22657 -3.03721,6.21097 -5.06479,7.63442 -2.05808,1.44499 -4.42417,1.21725 -6.58632,0.48342 -2.75196,-0.93387 -4.94253,-6.02088 -7.73876,-6.08526 -5.93669,-0.13659 -16.593609,12.15997 -16.593609,12.15997 z" />
    </svg>
</body>

<script type="text/javascript">
    //Service=======================================================================================
    function randomColor() {
        var chars = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++)
            color += chars[Math.floor(Math.random() * 16)];
        return color;
    };

    function componentToHEX(c) {
        let result = c.toString(16);
        if (result.length == 1) {
            result = '0' + result;
        }
        return result;
    }

    function RGBToHex(r, g, b) {
        return '#' + componentToHEX(r) + componentToHEX(g) + componentToHEX(b);
    }

    function visualizeVertexOrder(vertices) {
        for (let i = 0; i < vertices.length; i++) {
            let marker = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
            marker.setAttribute('cx', vertices[i].x);
            marker.setAttribute('cy', vertices[i].y);
            marker.setAttribute('r', 4);
            let color = Math.round((i / vertices.length) * 255);
            marker.setAttribute('fill', RGBToHex(255, color, color));
            canvas.appendChild(marker);
        }
    }

    //==============================================================================================

    var canvas = document.getElementById('canvas');
    var speed = document.getElementById('speed');
    var processor;
    var svgProcessor = CollisionSvgModelProcessor();
    var figures = [
        0,
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12
    ];

    async function init() {
        for (let p = 0; p < figures.length; p++) {
            let path = document.getElementById('path' + figures[p]);
            let svgTextRef = { reference: path.getAttribute('d') };
            var vertices = svgProcessor.processCollisionSvgModel(svgTextRef, Deg2Rad(180));
            console.log(vertices);
            //Visualising version requires to be recreated each time
            processor = new VisualisingCollisionModelProcessor(canvas, 100, 0);
            await processor.process(vertices);
        }


        /*
        for (let p = 0; p < figures.length; p++) {
            let path = document.getElementById('path' + figures[p]);

            var parser = new CollisionSvgModelProcessor();
            var processor = new CollisionModelProcessor(canvas);

            var svgTextRef = { reference: path.getAttribute('d') };
            console.log(svgTextRef);
            var vertices = parser.parseCollisisonSVGModel(svgTextRef);
            visualizeVertexOrder(vertices);
            console.log(vertices);

            if(false){
                continue;
            }

            var model = processor.process(vertices);
            console.log(model);

            for (let i = 0; i < model.convexSegments.length; i++) {
                let segment = document.createElementNS("http://www.w3.org/2000/svg", 'path');
                segment.setAttribute('fill-opacity', 0.5);
                segment.setAttribute('fill', randomColor());
                let d = 'M' + model.vertices.cartesian[model.convexSegments[i][0]].x + ',' + model.vertices.cartesian[model.convexSegments[i][0]].y
                for (let v = 1; v < model.convexSegments[i].length; v++) {
                    d += 'L' + model.vertices.cartesian[model.convexSegments[i][v]].x + ',' + model.vertices.cartesian[model.convexSegments[i][v]].y;
                }
                d += 'Z';
                segment.setAttribute('d', d);
                canvas.appendChild(segment);
            }
            */
    }

    //==============================================================================================

    function setSpeed() {
        if (!isNaN(speed.value)) {
            processor.setAutoUpdateInterval(speed.value);
            processor.step();
        }
    }

    //==============================================================================================

    function stop() {
        let v = speed.value;
        speed.value = 0;
        setSpeed();
        speed.value = v;
    }
</script>
<!--
    при определении перегибов, пара из первой и последней точек должна тестировать мануально, т.к. не может быть обработана циклом
-->

</html>